#!/usr/bin/env bash

set -eo pipefail

# Ensure common binary paths are available
export PATH="/usr/local/bin:/opt/homebrew/bin:/usr/bin:/bin:${PATH}"

# Check if kubectl is available
if ! command -v kubectl &>/dev/null; then
  echo "N/A"
  exit 0
fi

# Get current context
if ! context="$(kubectl config current-context 2>/dev/null)"; then
  echo "N/A"
  exit 0
fi

# Get namespace for the current context
namespace="$(kubectl config view -o "jsonpath={.contexts[?(@.name==\"${context}\")].context.namespace}" 2>/dev/null)"
if [[ -z "${namespace}" ]]; then
  namespace="default"
fi

# Strip cloud provider region suffixes for cleaner display
# Handles common patterns from GCP, AWS, Azure
# Examples:
#   - GCP: gke_project_asia-northeast1-a_cluster -> gke_project_cluster
#   - AWS: arn:aws:eks:us-west-2:account:cluster/name -> cluster/name
#   - Azure: context_eastus -> context
context="${context##*/}"  # Remove path-like prefixes (for ARN)
context="${context%%_[a-z]*-[a-z]*-[0-9]*}"  # Remove GCP-style region suffix
context="${context%%_[a-z]*-[a-z]*[0-9]*}"   # Remove Azure/AWS-style region suffix
context="${context%%_[a-z]*[0-9]*}"          # Remove short region patterns

echo "${context}/${namespace}"
