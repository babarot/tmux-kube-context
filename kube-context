#!/usr/bin/env bash

set -eo pipefail

# Ensure common binary paths are available
export PATH="/usr/local/bin:/opt/homebrew/bin:/usr/bin:/bin:${PATH}"

# Check if kubectl is available
if ! command -v kubectl &>/dev/null; then
  echo "N/A"
  exit 0
fi

# Get current context
if ! context="$(kubectl config current-context 2>/dev/null)"; then
  echo "N/A"
  exit 0
fi

# Get namespace for the current context
namespace="$(kubectl config view -o "jsonpath={.contexts[?(@.name==\"${context}\")].context.namespace}" 2>/dev/null)"
if [[ -z "${namespace}" ]]; then
  namespace="default"
fi

# Strip cloud provider region suffixes and format for cleaner display
# Handles common patterns from GCP, AWS, Azure
# Examples:
#   - GCP: gke_project_asia-northeast1-a_cluster -> project:cluster
#   - AWS: arn:aws:eks:us-west-2:account:cluster/name -> name
#   - Azure: aks_project_eastus_cluster -> project:cluster
context="${context##*/}"  # Remove path-like prefixes (for ARN)

# Remove cloud provider prefixes first (gke_, aks_, eks_, etc.)
context="${context#gke_}"
context="${context#aks_}"
context="${context#eks_}"

# Now remove region patterns - since provider prefix is gone, we can safely match region patterns
# Remove GCP-style region patterns: _region-zone_ or _region-zone at the end
# Pattern matches: _word-word+digits-letter[_] (e.g., _asia-northeast1-a_)
context="$(echo "${context}" | sed -E 's/_[a-z]+-[a-z]+[0-9]+-[a-z]_/_/g; s/_[a-z]+-[a-z]+[0-9]+-[a-z]$//')"
# Remove AWS-style region patterns: _region-zone_ (middle) or at the end
# Pattern matches: _word-word-digits[_] (e.g., _us-west-2_)
context="$(echo "${context}" | sed -E 's/_[a-z]+-[a-z]+-[0-9]+_/_/g; s/_[a-z]+-[a-z]+-[0-9]+$//')"
# Remove Azure-style regions: _eastus_, _westus_, _eastus2_, etc.
# After removing provider prefix, the format is: project_region_cluster
# Match common Azure region patterns in the middle position
context="$(echo "${context}" | sed -E 's/_(east|west|central|north|south)(us|eu|asia|uk|au|in|japan|korea|canada|france|germany|brazil|uae)[0-9]*_/_/')"

# Replace first underscore with colon for better readability (project:cluster)
context="${context/_/:}"

echo "${context}/${namespace}"
